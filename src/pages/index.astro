---
// --- Server Side (Runs on Cloudflare) ---

export const prerender = false; // Force dynamic server rendering

// DATA SOURCE: Kraken Exchange Public API (Tier 1 Reliability)
// Pair IDs: XAUUSD (Gold), XAGUSD (Silver)
// Interval: 1440 (Daily / 24 Hours)
const KRAKEN_GOLD = "https://api.kraken.com/0/public/OHLC?pair=XAUUSD&interval=1440";
const KRAKEN_SILVER = "https://api.kraken.com/0/public/OHLC?pair=XAGUSD&interval=1440";

let goldPrice = 0, silverPrice = 0;
let dateLabel = "Loading...", nextUpdateLabel = "";
let goldPoints = "", silverPoints = "";
let chartAvailable = false;
let errorMsg = "";

// Helper: Fetch with strict timeout and no-cache
async function getJson(url) {
  try {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), 4000); // 4s timeout
    const res = await fetch(url, { signal: controller.signal, cache: "no-store" });
    clearTimeout(id);
    if (!res.ok) throw new Error(`Status ${res.status}`);
    return await res.json();
  } catch (e) { 
    console.error("API Error:", e);
    return null; 
  }
}

function makeSparkline(data) {
  if (!data || data.length < 2) return "";
  const min = Math.min(...data);
  const max = Math.max(...data);
  return data.map((p, i) => {
    const x = (i / (data.length - 1)) * 100;
    const y = 100 - ((p - min) / (max - min)) * 100;
    return `${x},${y}`;
  }).join(" ");
}

try {
  const [gData, sData] = await Promise.all([
    getJson(KRAKEN_GOLD),
    getJson(KRAKEN_SILVER)
  ]);

  // Kraken returns { result: { PairName: [ [time, open, high, low, close...], ... ] } }
  // We use Object.values() to ignore the specific pair name key (e.g. XXAUZUSD)
  if (!gData?.result || !sData?.result) throw new Error("Kraken Blocked");

  const gOhcl = Object.values(gData.result)[0]; // First value is the data array
  const sOhcl = Object.values(sData.result)[0];

  // Get last 30 days only
  const gSlice = gOhcl.slice(-30);
  const sSlice = sOhcl.slice(-30);

  // KRAKEN FORMAT: [ time(sec), open, high, low, close, vwap, volume, count ]
  // Index 0 = Time, Index 4 = Close Price
  const lastCandle = gSlice[gSlice.length - 1]; // Most recent daily candle
  
  // Note: Kraken's last candle is "incomplete/live" for today.
  // Ideally for stability we want the *previous* fully closed candle (yesterday).
  // But to prevent "stale" looks, we will use the current live daily candle (Index -1).
  
  goldPrice = parseFloat(lastCandle[4]);
  silverPrice = parseFloat(sSlice[sSlice.length - 1][4]);

  // Generate Timestamp from the candle time
  const dataTime = new Date(lastCandle[0] * 1000);
  const dateStr = dataTime.toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric'
  });

  dateLabel = `Data: Kraken Spot (${dateStr})`;
  nextUpdateLabel = "Updates Live on Refresh";

  // Charts
  goldPoints = makeSparkline(gSlice.map(c => parseFloat(c[4])));
  silverPoints = makeSparkline(sSlice.map(c => parseFloat(c[4])));
  chartAvailable = true;

} catch (e) {
  errorMsg = e.message || "Connection Error";
  goldPrice = 2500; silverPrice = 30; // Fail-safe
  dateLabel = "Offline Mode";
  nextUpdateLabel = "Check Connection";
}

const historicalData = {
  2010: { gold: 1224, silver: 20.19 },
  2011: { gold: 1571, silver: 35.12 },
  2012: { gold: 1668, silver: 31.15 },
  2013: { gold: 1411, silver: 23.79 },
  2014: { gold: 1266, silver: 19.08 },
  2015: { gold: 1160, silver: 15.68 },
  2016: { gold: 1250, silver: 17.14 },
  2017: { gold: 1257, silver: 17.04 },
  2018: { gold: 1268, silver: 15.71 },
  2019: { gold: 1392, silver: 16.21 },
  2020: { gold: 1769, silver: 20.55 },
  2021: { gold: 1798, silver: 25.14 },
  2022: { gold: 1801, silver: 21.76 },
  2023: { gold: 1940, silver: 23.35 },
  2024: { gold: 2350, silver: 28.50 },
  2025: { gold: 2650, silver: 32.00 },
  2026: { gold: goldPrice, silver: silverPrice }
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Metal Dashboard</title>
    <style>
      :root { --bg: #f4f4f9; --card: #ffffff; --gold: #d4af37; --silver: #7f8c8d; --text: #333; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
      .dashboard { width: 100%; max-width: 960px; display: flex; flex-direction: column; gap: 15px; }
      @media (min-width: 768px) { .dashboard { display: grid; grid-template-columns: 1.8fr 1fr; align-items: start; gap: 20px; } .header-section, .footer-section { grid-column: 1 / -1; } }
      .card { background: var(--card); padding: 1.5rem; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); }
      h1 { margin: 0; font-size: 1.5rem; text-align: center; color: #222; }
      
      .badge-container { text-align: center; margin: 10px 0 20px 0; }
      .badge { 
        display: inline-block; 
        font-size: 0.9rem; font-weight: 600; color: #555; 
        background: #fff; padding: 8px 18px; border-radius: 30px; 
        border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .badge-sub { display: block; font-size: 0.75rem; color: #999; margin-top: 4px; font-weight: 400; }
      .error-pill { color: red; font-size: 0.7rem; display: block; margin-top: 5px; }

      .price-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
      .price-item { background: #fafafa; padding: 12px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
      .lbl { font-size: 0.65rem; text-transform: uppercase; font-weight: 700; color: #999; letter-spacing: 0.5px; }
      .val { font-size: 1.2rem; font-weight: 700; margin-top: 2px; }
      .input-group { margin-bottom: 15px; }
      .group-label { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
      .dot { width: 8px; height: 8px; border-radius: 50%; }
      .input-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; }
      input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
      input:focus { outline: 2px solid #333; border-color: transparent; }
      .res-box { margin-top: 8px; font-size: 0.85rem; padding: 12px; background: #f8f9fa; border-radius: 8px; display: none; line-height: 1.6; }
      .res-box.visible { display: block; animation: slideDown 0.2s ease-out; }
      .up { color: #16a34a; font-weight: 700; }
      .down { color: #dc2626; font-weight: 700; }
      button { width: 100%; background: #222; color: #fff; border: none; padding: 14px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 5px; }
      .chart-stack { display: flex; flex-direction: column; gap: 15px; }
      .chart-card { background: var(--card); border-radius: 16px; padding: 1.2rem; flex: 1; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); }
      .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.8rem; font-weight: 700; color: #555; }
      .svg-container { flex-grow: 1; position: relative; height: 120px; min-height: 120px; display: flex; align-items: center; justify-content: center; }
      .no-chart { font-size: 0.8rem; color: #999; font-style: italic; background: #f9f9f9; padding: 10px 20px; border-radius: 20px; }
      svg { width: 100%; height: 100%; overflow: visible; }
      polyline { fill: none; stroke-width: 2; vector-effect: non-scaling-stroke; stroke-linecap: round; }
      .legal { text-align: center; font-size: 0.7rem; color: #aaa; margin-top: 20px; line-height: 1.4; }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="header-section">
        <h1>Metal Tracker</h1>
        
        <div class="badge-container">
          <div class="badge">
            {dateLabel}
            <span class="badge-sub">{nextUpdateLabel}</span>
            {errorMsg && <span class="error-pill">Debug: {errorMsg}</span>}
          </div>
        </div>
      </div>

      <div class="card">
        <div class="price-grid">
          <div class="price-item">
            <div class="lbl">Gold (Spot)</div>
            <div class="val" style="color:var(--gold)">${goldPrice.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
          </div>
          <div class="price-item">
            <div class="lbl">Silver (Spot)</div>
            <div class="val" style="color:var(--silver)">${silverPrice.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
          </div>
        </div>

        <div class="input-group">
          <div class="group-label"><div class="dot" style="background:var(--gold)"></div> Gold Holdings</div>
          <div class="input-row">
            <input type="number" step="0.01" id="goldOz" placeholder="Ounces" />
            <input type="number" id="goldYear" placeholder="Year Purchased" min="2010" max="2026" />
          </div>
          <div id="goldRes" class="res-box"></div>
        </div>

        <div class="input-group">
          <div class="group-label"><div class="dot" style="background:var(--silver)"></div> Silver Holdings</div>
          <div class="input-row">
            <input type="number" step="0.01" id="silverOz" placeholder="Ounces" />
            <input type="number" id="silverYear" placeholder="Year Purchased" min="2010" max="2026" />
          </div>
          <div id="silverRes" class="res-box"></div>
        </div>
        <button id="calcBtn">Calculate Value</button>
      </div>

      <div class="chart-stack">
        <div class="chart-card">
          <div class="chart-header">
            <span>Gold Trend (30D)</span>
            <span style="color:var(--gold)">${goldPrice.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
          </div>
          <div class="svg-container">
            {chartAvailable ? 
              <svg viewBox="0 0 100 100" preserveAspectRatio="none"><polyline points={goldPoints} stroke="#d4af37" /></svg> 
              : <div class="no-chart">Chart Unavailable</div>
            }
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <span>Silver Trend (30D)</span>
            <span style="color:var(--silver)">${silverPrice.toLocaleString(undefined, {maximumFractionDigits:2})}</span>
          </div>
          <div class="svg-container">
            {chartAvailable ? 
              <svg viewBox="0 0 100 100" preserveAspectRatio="none"><polyline points={silverPoints} stroke="#7f8c8d" /></svg> 
              : <div class="no-chart">Chart Unavailable</div>
            }
          </div>
        </div>
      </div>

      <div class="footer-section legal">
        Market Data: Kraken Exchange (Public API).<br/>
        <strong>EDUCATIONAL USE ONLY.</strong> Not financial advice.
      </div>
    </div>

    <script define:vars={{ goldPrice, silverPrice, historicalData }}>
      document.getElementById('calcBtn').addEventListener('click', () => {
        runCalc('gold', goldPrice);
        runCalc('silver', silverPrice);
      });

      function runCalc(type, price) {
        const ozEl = document.getElementById(type+'Oz');
        const yearEl = document.getElementById(type+'Year');
        const resEl = document.getElementById(type+'Res');
        
        const oz = parseFloat(ozEl.value);
        const year = yearEl.value;

        if (!oz) { resEl.classList.remove('visible'); return; }

        const total = oz * price;
        const totalFormatted = total.toLocaleString(undefined, {minimumFractionDigits: 2});
        
        let html = `<div>Current Value: <strong>$${totalFormatted}</strong></div>`;

        if (year && historicalData[year]) {
          const oldPrice = historicalData[year][type];
          const originalCost = oz * oldPrice;
          const diff = total - originalCost;
          const isUp = diff >= 0;
          const diffStr = Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits: 2});
          const pct = ((diff / originalCost) * 100).toFixed(1);
          
          html += `<div style="font-size:0.85em; color:#666; margin-top:5px;">History: Bought ${year}</div>`;
          html += `<div style="margin-top:2px; font-weight:600;">${isUp?'Profit':'Loss'}: <span class="${isUp?'up':'down'}">${isUp?'+':'-'}$${diffStr} (${isUp?'+':''}${pct}%)</span></div>`;
        }
        resEl.innerHTML = html;
        resEl.classList.add('visible');
      }
    </script>
  </body>
</html>